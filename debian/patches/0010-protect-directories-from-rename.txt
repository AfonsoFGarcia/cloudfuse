From ad9f1246b6c63c380f67c5af2144f87091dea3ed Mon Sep 17 00:00:00 2001
From: Mike Barton <mike@weirdlooking.com>
Date: Fri, 12 Aug 2011 10:41:08 +0000
Subject: [PATCH 10/17] protect directories from rename

---
 README      |    4 +---
 cloudfuse.c |    2 ++
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/README b/README
index 451eae1..7da4e6d 100644
--- a/README
+++ b/README
@@ -58,9 +58,7 @@ USE:
 
 BUGS/SHORTCOMINGS:
 
-    * Doesn't implement rename().  There's no good way to do this with the
-      Cloud Files API.  Unfortunately, this makes cloudfuse considerably less
-      useful in Finder, as it expects to be able to rename a lot.
+    * rename() doesn't work on directories (and probably never will).
     * When reading and writing files, it buffers them in a local temp file.
     * It keeps an in-memory cache of the directory structure, so it may not be
       usable for large file systems.  Also, files added by other applications
diff --git a/cloudfuse.c b/cloudfuse.c
index d04fece..af8bfc8 100644
--- a/cloudfuse.c
+++ b/cloudfuse.c
@@ -392,6 +392,8 @@ static int cfs_rename(const char *src, const char *dst)
   dir_entry *src_de = path_info(src);
   if (!src_de)
       return -ENOENT;
+  if (src_de->isdir)
+    return -EISDIR;
   if (copy_object(src, dst))
   {
     /* FIXME this isn't quite right as doesn't preserve last modified */
-- 
1.7.9.5

